

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>31. Más comportamientos complejos &mdash; documentación de Maestría en Plone 4 - 1.2.5a</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
        <link rel="author" title="Sobre este documento"
              href="about.html"/>
    <link rel="top" title="documentación de Maestría en Plone 4 - 1.2.5a" href="index.html"/>
        <link rel="next" title="32. Un viewlet para el comportamiento voteable" href="viewlets_2.html"/>
        <link rel="prev" title="30. Creando paquetes reusables con Eggs" href="eggs2.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Maestría en Plone 4
          

          
          </a>

          
            
            
              <div class="version">
                1.2.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="about.html">Sobre &#8220;Maestría en Plone&#8221;</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introducción</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">2. Instalación y configuración</a></li>
<li class="toctree-l1"><a class="reference internal" href="plone_training_config/instructions.html">3. Instalando Plone para el entrenamiento</a></li>
<li class="toctree-l1"><a class="reference internal" href="anatomy.html">4. La Anatomía de Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="case.html">5. El caso de estudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">6. Las características de Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring_customizing.html">7. Configurando y personalizando Plone a través de la Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">8. Extendiendo Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="addons.html">9. Extiende Plone con paquetes Complementos</a></li>
<li class="toctree-l1"><a class="reference internal" href="theming.html">10. Temas</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity.html">11. Dexterity - Parte I: A través de la Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildout_1.html">12. Buildout - Parte I</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs1.html">13. Creando complementos para personalizar Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="views_1.html">14. Views - Parte I</a></li>
<li class="toctree-l1"><a class="reference internal" href="zpt.html">15. Zope Page Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="zpt_2.html">16. Personalizar plantillas existentes</a></li>
<li class="toctree-l1"><a class="reference internal" href="views_2.html">17. Views - Parte II: Una vista por defecto para la &#8220;charla&#8221;</a></li>
<li class="toctree-l1"><a class="reference internal" href="views_3.html">18. Views - Parte III: Una lista de Charlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="behaviors1.html">19. Comportamientos</a></li>
<li class="toctree-l1"><a class="reference internal" href="viewlets_1.html">20. Escribiendo Viewlets</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">21. Programando en Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="ide.html">22. IDEs y editores</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity_2.html">23. Tipos Dexterity - Parte II: Creciendo</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_search.html">24. Búsqueda personalizada</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">25. Convertir las charlas en eventos</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_generated_content.html">26. Usar contenido generado</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">27. Recursos</a></li>
<li class="toctree-l1"><a class="reference internal" href="thirdparty_behaviors.html">28. Usando comportamientos de complementos de terceros</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity_3.html">29. Tipos Dexterity - III: Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs2.html">30. Creando paquetes reusables con Eggs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">31. Más comportamientos complejos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-annotations">Usando Anotaciones</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-schema">Usando Esquema</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-code">Escribiendo código</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="viewlets_2.html">32. Un viewlet para el comportamiento voteable</a></li>
<li class="toctree-l1"><a class="reference internal" href="reusable.html">33. Haciendo nuestro paquete reusable</a></li>
<li class="toctree-l1"><a class="reference internal" href="embed.html">34. Usando starzel.votable_behavior en ploneconf.site</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_sites.html">35. Buildout - Parte II: Cómo prepararse para el despliegue</a></li>
<li class="toctree-l1"><a class="reference internal" href="future_of_plone.html">36. El futuro de Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="optional.html">37. Opcional</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="CHANGES.html">Cambios</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Mapa de ruta</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Maestría en Plone 4</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>31. Más comportamientos complejos</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="more-complex-behaviors">
<h1>31. Más comportamientos complejos<a class="headerlink" href="#more-complex-behaviors" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="section" id="using-annotations">
<h2>Usando Anotaciones<a class="headerlink" href="#using-annotations" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Vamos a almacenar la información en una anotación. No porque se necesita, sino porque se encuentra el código que utiliza anotaciones y la necesidad de entender las implicaciones.</p>
<p><a class="reference external" href="https://pypi.python.org/pypi/zope.annotation/4.2.0">Annotations</a> en Zope / Plone significa que los datos no serán almacenados directamente en un objeto, sino de una manera indirecta y con multiple espacios de nombres para que varios paquetes pueden almacenar información bajo el mismo atributo, sin colisionar.</p>
<p>Así que usando anotaciones evita los conflictos de nombres. El costo es una indirección. El diccionario es persistente por lo que tiene que ser almacenado por separado. Además, se podría dar atributos un nombre que contiene un prefijo de espacio de nombres para evitar colisiones de nombres.</p>
</div>
<div class="section" id="using-schema">
<h2>Usando Esquema<a class="headerlink" href="#using-schema" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El atributo donde almacenamos nuestros datos será declarado como un campo de esquema. Marcamos el campo como un campo omitido, porque no vamos a crear widgets z3c.form para mostrarlos. Nosotros ofrecemos un esquema, porque muchos otros paquetes utilizan la información de esquema para obtener el conocimiento de los campos pertinentes.</p>
<p>Por ejemplo, cuando los archivos se han migrado a blobs, los nuevos objetos tuvieron que ser creados y cada campo de esquema fue copiado. El código no puede saber acerca de nuestro campo, excepto si proporcionamos información de esquema.</p>
</div>
<div class="section" id="writing-code">
<h2>Escribiendo código<a class="headerlink" href="#writing-code" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para iniciar, creamos un directorio <code class="file docutils literal"><span class="pre">behavior</span></code> con un archivo vació <code class="file docutils literal"><span class="pre">behavior/__init__.py</span></code>.</p>
<p>Luego debemos, como siempre, registrar nuestro ZCML.</p>
<p>Primero, agrega la información de que existe otro archivo ZCML en <code class="file docutils literal"><span class="pre">configure.zcml</span></code></p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>&lt;configure
      ...&gt;

  ...
  &lt;include package=&quot;.behavior&quot; /&gt;
  ...

&lt;/configure&gt;
</pre></div>
</td></tr></table></div>
<p>Luego, cree el archivo <code class="file docutils literal"><span class="pre">behavior/configure.zcml</span></code></p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">&lt;configure</span>
    <span class="na">xmlns=</span><span class="s">&quot;http://namespaces.zope.org/zope&quot;</span>
    <span class="na">xmlns:plone=</span><span class="s">&quot;http://namespaces.plone.org/plone&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;plone:behavior</span>
      <span class="na">title=</span><span class="s">&quot;Voting&quot;</span>
      <span class="na">description=</span><span class="s">&quot;Allow voting for an item&quot;</span>
      <span class="na">provides=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVoting&quot;</span>
      <span class="na">factory=</span><span class="s">&quot;.voting.Vote&quot;</span>
      <span class="na">marker=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVotable&quot;</span>
      <span class="nt">/&gt;</span>

<span class="nt">&lt;/configure&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Hay algunas diferencias importantes de nuestro primer comportamiento:</p>
<blockquote>
<div><ul class="simple">
<li><p class="first">Hay una interfaz marcador</p>
</li>
<li><p class="first">Hay una fabrica</p>
</li>
</ul>
</div></blockquote>
<p>La fábrica es una clase que proporciona la lógica de comportamiento y da acceso a los atributos que ofrecemos. Las fábricas en la tierra de Plone / Zope se recuperan mediante la adaptación de un objeto con una interfaz. Si usted quiere su comportamiento, usted escribiría <code class="samp docutils literal"><span class="pre">IVoting(object)</span></code></p>
<p>Pero para que esto funcione, el objeto <em>no</em> puede estar implementando la interfaz IVoting, porque si lo haría, ¡ <code class="samp docutils literal"><span class="pre">IVoting(object)</span></code> devolvería el objeto en sí mismo!. Si yo necesito una interfaz marcador de los objetos proporcionando mi comportamiento, yo debo proporcionar uno, para esto usamos el atributo marcador. Mi objeto implementa <code class="samp docutils literal"><span class="pre">IVotable</span></code> y debido a esto, podemos escribir vistas y viewlets sólo para este tipo de contenido.</p>
<p>Las interfaces necesitan ser escritas, en nuestro caso en un archivo <code class="file docutils literal"><span class="pre">interfaces.py</span></code>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">plone</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">plone.autoform</span> <span class="kn">import</span> <span class="n">directives</span> <span class="k">as</span> <span class="n">form</span>
<span class="kn">from</span> <span class="nn">plone.autoform.interfaces</span> <span class="kn">import</span> <span class="n">IFormFieldProvider</span>
<span class="kn">from</span> <span class="nn">plone.supermodel</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">plone.supermodel</span> <span class="kn">import</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">zope</span> <span class="kn">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">alsoProvides</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">Interface</span>

<span class="k">class</span> <span class="nc">IVotableLayer</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marker interface for the Browserlayer</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1"># Ivotable is the marker interface for contenttypes who support this behavior</span>
<span class="k">class</span> <span class="nc">IVotable</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># This is the behaviors interface. When doing IVoting(object),you receive an</span>
<span class="c1"># adapter</span>
<span class="k">class</span> <span class="nc">IVoting</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">():</span>
        <span class="n">form</span><span class="o">.</span><span class="n">omitted</span><span class="p">(</span><span class="s2">&quot;votes&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">omitted</span><span class="p">(</span><span class="s2">&quot;voted&quot;</span><span class="p">)</span>

    <span class="n">directives</span><span class="o">.</span><span class="n">fieldset</span><span class="p">(</span>
        <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">u&#39;debug&#39;</span><span class="p">,</span>
        <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;votes&#39;</span><span class="p">,</span> <span class="s1">&#39;voted&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">votes</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">u&quot;Vote info&quot;</span><span class="p">,</span>
                        <span class="n">key_type</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">u&quot;Voted number&quot;</span><span class="p">),</span>
                        <span class="n">value_type</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">u&quot;Voted so often&quot;</span><span class="p">),</span>
                        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">voted</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">u&quot;Vote hashes&quot;</span><span class="p">,</span>
                        <span class="n">value_type</span><span class="o">=</span><span class="n">schema</span><span class="o">.</span><span class="n">TextLine</span><span class="p">(),</span>
                        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store the vote information, store the request hash to ensure</span>
<span class="sd">        that the user does not vote twice</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">average_vote</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the average voting for an item</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_votes</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether anybody ever voted for this item</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">already_voted</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the information wether a person already voted.</span>
<span class="sd">        This is not very high level and can be tricked out easily</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the votes. Should only be called by admins</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="n">alsoProvides</span><span class="p">(</span><span class="n">IVoting</span><span class="p">,</span> <span class="n">IFormFieldProvider</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Se trata de una gran cantidad de código. El IVotableLayer nosotros lo necesitaremos más tarde para viewlets y browser views. Permite agregar aquí mismo. La interfaz IVotable es la interfaz marcador simple. Sólo se utiliza para enlazar las browser views y viewlets a tipos de contenido que proporcionan nuestro comportamiento, por lo que no hay código necesario.</p>
<p>La clase IVoting es más compleja, como se puede ver. Mientras IVoting es sólo una interfaz, utilizamos <code class="samp docutils literal"><span class="pre">plone.supermodel.model.Schema</span></code> para las características avanzadas Dexterity. El paquete zope.schema no proporciona medios para ocultar campos. La directivas <code class="samp docutils literal"><span class="pre">form.omitted</span></code>  de <code class="samp docutils literal"><span class="pre">plone.autoform</span></code> nos permite nosotros anotar esta información adicional para que los auto-formularios renderizados pueden utilizar la información adicional.</p>
<p>Hacemos esta omitir condicional. Si ejecutamos Plone en modo de depuración, seremos capaces de ver los datos internos en el formulario de edición.</p>
<p>Creamos los campos mínimos esquema para nuestras estructuras de datos internas. Por una pequeña prueba, yo le quité las directivas omitida de formulario y abrí la vista de edición de un tipo de contenido charla que utiliza el comportamiento. Después de ver la fealdad, yo decidí que debía proporcionar al menos mínimo de información. Los títulos y requerido son puramente opcional, pero muy útil si no se omitirán los campos, algo que puede ser útil al depurar el comportamiento. Más tarde, cuando ponemos en práctica el comportamiento, los atributos <code class="samp docutils literal"><span class="pre">votes</span></code> y <code class="samp docutils literal"><span class="pre">voted</span></code> se apliquen de tal manera que no se puede simplemente modificar estos campos, que son de sólo lectura.</p>
<p>Luego definimos la API que vamos a usar en los browser views y viewlets.</p>
<p>La última línea se asegura de que los campos de esquema son conocidos por otros paquetes. Siempre que algún código quiere que todos los esquemas de un objeto, que recibe el esquema definido directamente sobre el objeto y los esquemas adicional. Los esquemas adicionales se compilan mediante la búsqueda de comportamientos y si ofrecen  la funcionalidad <code class="samp docutils literal"><span class="pre">IFormFieldProvider</span></code>. Sólo entonces nuestros campos son conocidos como campos de esquema.</p>
<p>Ahora la única cosa que falta es el comportamiento, la cual debemos colocar en <code class="file docutils literal"><span class="pre">behavior/voting.py</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">persistent.dict</span> <span class="kn">import</span> <span class="n">PersistentDict</span>
<span class="kn">from</span> <span class="nn">persistent.list</span> <span class="kn">import</span> <span class="n">PersistentList</span>
<span class="kn">from</span> <span class="nn">zope.annotation.interfaces</span> <span class="kn">import</span> <span class="n">IAnnotations</span>

<span class="n">KEY</span> <span class="o">=</span> <span class="s2">&quot;starzel.votable_behavior.behavior.voting.Vote&quot;</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">KEY</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">PersistentDict</span><span class="p">({</span>
                <span class="s2">&quot;voted&quot;</span><span class="p">:</span> <span class="n">PersistentList</span><span class="p">(),</span>
                <span class="s1">&#39;votes&#39;</span><span class="p">:</span> <span class="n">PersistentDict</span><span class="p">()</span>
                <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;votes&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">voted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;voted&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>En nuestro método <code class="samp docutils literal"><span class="pre">__init__</span></code> obtenemos las <em>anotaciones</em> del objeto. Buscamos los datos con una clave específica.</p>
<p>La clave en este ejemplo es el mismo que lo que obtendría con <code class="samp docutils literal"><span class="pre">__name__+Vote.__name__</span></code>. Pero no vamos a crear un nombre dinámico, esto sería muy inteligente y hábil, es malo.</p>
<p>Al declarar un nombre estático, no vamos a tener problemas si reestructuramos el código.</p>
<p>Usted puede ver, que inicializamos los datos si no existe. Trabajamos con PersistentDict y PersistentList. Para entender por qué hacemos esto, es importante entender cómo funciona el ZODB.</p>
<div class="admonition seealso">
<p class="first admonition-title">Ver también</p>
<p>El ZODB puede almacenar objetos. Tiene un objeto raíz especial que usted nunca toca. Cualquier cosa que usted almacena donde, formará parte del objeto raíz, excepto si se trata de un sublclassing objeto <code class="samp docutils literal"><span class="pre">persistent.Persistent</span></code>. Entonces se almacenará de forma independiente.</p>
<p>Tenga cuenta que los objetos persistentes Zope/ZODB cuando se cambia un atributo en él y marcar como cambiado. Los objetos modificados se guardarán en la base de datos. Esto sucede automáticamente. Cada request inicia una transacción y después de nuestro código corrió y el servidor Zope está preparando para enviar de nuevo la respuesta que nosotros generamos, la transacción sera enviada y todo lo cambiamos, será salvo.</p>
<p>Ahora, si tienen un diccionario normal sobre un objeto persistente, y usted sólo va a cambiar el diccionario, el objeto persistente no tiene manera de saber, si el diccionario se ha cambiado. Esto <a class="reference external" href="https://github.com/plone/Products.CMFEditions/commit/5c07c72bc8701cf28c9cc68ad940186b9e296ddf">sucede</a> de vez en cuando.</p>
<p>Así que una solución es cambiar el atributo especial <code class="samp docutils literal"><span class="pre">_p_changed</span></code> a <code class="samp docutils literal"><span class="pre">True</span></code> en el objeto persistente, o utilizar un PersistentDict. Eso es lo que estamos haciendo aquí.</p>
<p class="last">Puede encontrar más información en la documentación de la ZODB, en particular, <a class="reference external" href="http://www.zodb.org/en/latest/articles/old-guide/prog-zodb.html#rules-for-writing-persistent-classes">Reglas para Clases Persistentes</a></p>
</div>
<p>A continuación ofrecemos los campos internos a través de propiedades. El uso de este formulario de propiedad, hace que lean única propiedad, ya que no nos definimos manipuladores de escritura. Nosotros no los necesitamos para que no nos agregarlos.</p>
<p>Como se ha visto en la declaración de esquema, si ejecuta su sitio en modo de depuración, verá un campo de edición para estos campos. Pero si tratar de cambiar estos campos abra una excepción.</p>
<p>Continuemos con este archivo:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hash can be tricked out by changing IP addresses and might allow</span>
<span class="sd">        only a single person of a big company to vote</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hash_</span> <span class="o">=</span> <span class="n">md5</span><span class="p">()</span>
        <span class="n">hash_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">getClientAddr</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">,</span> <span class="s2">&quot;Accept-Language&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">]:</span>
            <span class="n">hash_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">getHeader</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vote</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_voted</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;You may not vote twice&quot;</span><span class="p">)</span>
        <span class="n">vote</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;voted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="n">votes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;votes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vote</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">votes</span><span class="p">:</span>
            <span class="n">votes</span><span class="p">[</span><span class="n">vote</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">votes</span><span class="p">[</span><span class="n">vote</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">average_vote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">total_votes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;votes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">total_points</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">vote</span> <span class="o">*</span> <span class="n">count</span> <span class="k">for</span> <span class="p">(</span><span class="n">vote</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="ow">in</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;votes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_points</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_votes</span>

    <span class="k">def</span> <span class="nf">has_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;votes&#39;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">already_voted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;voted&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">PersistentDict</span><span class="p">({</span><span class="s1">&#39;voted&#39;</span><span class="p">:</span> <span class="n">PersistentList</span><span class="p">(),</span>
                                           <span class="s1">&#39;votes&#39;</span><span class="p">:</span> <span class="n">PersistentDict</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Empezamos con un poco del método helper que no está expuesta a través de la interfaz. No queremos que la gente vote dos veces. Hay muchas formas para asegurar esto y cada uno tiene defectos.</p>
<p>Elegimos esta manera de mostrar cómo acceder a la información de la request del navegador del usuario que nos envió. En primer lugar, tenemos la IP del usuario, entonces podemos acceder a un pequeño conjunto de encabezados desde el navegador de los usuarios y generar una suma de comprobación MD5 de esto.</p>
<p>El método de votación, quiere un voto y una request. Comprobamos las condiciones previas, a continuación, convertimos el voto a un número entero, almacenar la request que tiene <code class="samp docutils literal"><span class="pre">voted</span></code> y los votos en el diccionario <code class="samp docutils literal"><span class="pre">votes</span></code>. Sólo contamos allí, con qué frecuencia se ha dado ninguna votación.</p>
<p>Todo lo demás es simplemente código Python aburrido.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="viewlets_2.html" class="btn btn-neutral float-right" title="32. Un viewlet para el comportamiento voteable" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="eggs2.html" class="btn btn-neutral" title="30. Creando paquetes reusables con Eggs" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright El texto y las ilustraciones en este sitio Web esta licenciadas por la Plone Foundation bajo la licencia Creative Commons Attribution 4.0 International.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.2.5a',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .admonition-title").show();
        $(".toggle .admonition-title").click(function() {
            $(this).parent().children().not(".admonition-title").toggle(400);
            $(this).parent().children(".admonition-title").toggleClass("open");
        })
    });
</script>


</body>
</html>