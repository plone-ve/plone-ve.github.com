

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>32. Un viewlet para el comportamiento voteable &mdash; documentación de Maestría en Plone 4 - 1.2.5a</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
        <link rel="author" title="Sobre este documento"
              href="about.html"/>
    <link rel="top" title="documentación de Maestría en Plone 4 - 1.2.5a" href="index.html"/>
        <link rel="next" title="33. Haciendo nuestro paquete reusable" href="reusable.html"/>
        <link rel="prev" title="31. Más comportamientos complejos" href="behaviors2.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Maestría en Plone 4
          

          
          </a>

          
            
            
              <div class="version">
                1.2.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="about.html">Sobre &#8220;Maestría en Plone&#8221;</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introducción</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">2. Instalación y configuración</a></li>
<li class="toctree-l1"><a class="reference internal" href="plone_training_config/instructions.html">3. Instalando Plone para el entrenamiento</a></li>
<li class="toctree-l1"><a class="reference internal" href="anatomy.html">4. La Anatomía de Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="case.html">5. El caso de estudio</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">6. Las características de Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring_customizing.html">7. Configurando y personalizando Plone a través de la Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">8. Extendiendo Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="addons.html">9. Extiende Plone con paquetes Complementos</a></li>
<li class="toctree-l1"><a class="reference internal" href="theming.html">10. Temas</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity.html">11. Dexterity - Parte I: A través de la Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildout_1.html">12. Buildout - Parte I</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs1.html">13. Creando complementos para personalizar Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="views_1.html">14. Views - Parte I</a></li>
<li class="toctree-l1"><a class="reference internal" href="zpt.html">15. Zope Page Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="zpt_2.html">16. Personalizar plantillas existentes</a></li>
<li class="toctree-l1"><a class="reference internal" href="views_2.html">17. Views - Parte II: Una vista por defecto para la &#8220;charla&#8221;</a></li>
<li class="toctree-l1"><a class="reference internal" href="views_3.html">18. Views - Parte III: Una lista de Charlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="behaviors1.html">19. Comportamientos</a></li>
<li class="toctree-l1"><a class="reference internal" href="viewlets_1.html">20. Escribiendo Viewlets</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">21. Programando en Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="ide.html">22. IDEs y editores</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity_2.html">23. Tipos Dexterity - Parte II: Creciendo</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_search.html">24. Búsqueda personalizada</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">25. Convertir las charlas en eventos</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_generated_content.html">26. Usar contenido generado</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">27. Recursos</a></li>
<li class="toctree-l1"><a class="reference internal" href="thirdparty_behaviors.html">28. Usando comportamientos de complementos de terceros</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity_3.html">29. Tipos Dexterity - III: Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs2.html">30. Creando paquetes reusables con Eggs</a></li>
<li class="toctree-l1"><a class="reference internal" href="behaviors2.html">31. Más comportamientos complejos</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">32. Un viewlet para el comportamiento voteable</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#voting-viewlet">Viewlet Voting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-the-viewlet-code">Escribiendo el código fuente del Viewlet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-template">La plantilla</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-javascript-code">El código javascript</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-2-simple-view-helpers">Escribiendo 2 ejemplo de view helpers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reusable.html">33. Haciendo nuestro paquete reusable</a></li>
<li class="toctree-l1"><a class="reference internal" href="embed.html">34. Usando starzel.votable_behavior en ploneconf.site</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_sites.html">35. Buildout - Parte II: Cómo prepararse para el despliegue</a></li>
<li class="toctree-l1"><a class="reference internal" href="future_of_plone.html">36. El futuro de Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="optional.html">37. Opcional</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="CHANGES.html">Cambios</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Mapa de ruta</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Maestría en Plone 4</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>32. Un viewlet para el comportamiento voteable</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="a-viewlet-for-the-voteable-behavior">
<h1>32. Un viewlet para el comportamiento voteable<a class="headerlink" href="#a-viewlet-for-the-voteable-behavior" title="Enlazar permanentemente con este título">¶</a></h1>
<div class="section" id="voting-viewlet">
<h2>Viewlet Voting<a class="headerlink" href="#voting-viewlet" title="Enlazar permanentemente con este título">¶</a></h2>
<ul class="simple">
<li><p class="first">Viewlet para IVoteable</p>
</li>
<li><p class="first">la plantilla del viewlet</p>
</li>
<li><p class="first">agregar jQuery incluyen declaraciones</p>
</li>
<li><p class="first">guardar el voto en el objeto usando anotaciones</p>
</li>
</ul>
<p>Anteriormente hemos agregado la lógica que salva los votos en los objetos. Nosotros ahora podemos crear la interfaz de usuario para esto.</p>
<p>Puesto que queremos utilizar la interfaz de usuario en más de una página (no sólo la vista talk-view sino también la vista talk-listing) debemos ponerla en alguna parte.</p>
<ul class="simple">
<li><p class="first">Para manejar el user-input nosotros no usamos un formulario pero si links y ajax.</p>
</li>
<li><p class="first">La votación en si, es en su efecto manejada por otra vista</p>
</li>
</ul>
<p>Registramos el viewlet en el archivo <code class="file docutils literal"><span class="pre">browser/configure.zcml</span></code>.</p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nt">&lt;configure</span> <span class="na">xmlns=</span><span class="s">&quot;http://namespaces.zope.org/zope&quot;</span>
     <span class="na">xmlns:browser=</span><span class="s">&quot;http://namespaces.zope.org/browser&quot;</span><span class="nt">&gt;</span>

     ...

<span class="hll">   <span class="nt">&lt;browser:viewlet</span>
</span><span class="hll">     <span class="na">name=</span><span class="s">&quot;voting&quot;</span>
</span><span class="hll">     <span class="na">for=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVoting&quot;</span>
</span><span class="hll">     <span class="na">manager=</span><span class="s">&quot;plone.app.layout.viewlets.interfaces.IBelowContentTitle&quot;</span>
</span><span class="hll">     <span class="na">layer=</span><span class="s">&quot;..interfaces.IVotableLayer&quot;</span>
</span><span class="hll">     <span class="na">class=</span><span class="s">&quot;.viewlets.Vote&quot;</span>
</span><span class="hll">     <span class="na">template=</span><span class="s">&quot;templates/voting_viewlet.pt&quot;</span>
</span><span class="hll">     <span class="na">permission=</span><span class="s">&quot;zope2.View&quot;</span>
</span><span class="hll">     <span class="nt">/&gt;</span>
</span>
     ....

 <span class="nt">&lt;/configure&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Nosotros extendemos en el archivo <code class="file docutils literal"><span class="pre">browser/viewlets.py</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plone.app.layout.viewlets</span> <span class="kn">import</span> <span class="n">common</span> <span class="k">as</span> <span class="n">base</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">ViewletBase</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<p>Esto agregará un viewlet a una ranura debajo del título y esperará una plantilla <code class="file docutils literal"><span class="pre">voting_viewlet.pt</span></code> en una carpeta <code class="file docutils literal"><span class="pre">browser/templates</span></code>.</p>
<p>Vamos a agregar el archivo de la plantilla <code class="file docutils literal"><span class="pre">templates/social_viewlet.pt</span></code> sin ninguna lógica.</p>
<div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;voting&quot;</span><span class="p">&gt;</span>
     Wanna vote? Write code!
 <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

 <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
   <span class="nx">jq</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
     <span class="c1">// please add some jQuery-magic</span>
   <span class="p">});</span>
 <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li><p class="first">reiniciar Plone</p>
</li>
<li><p class="first">mostrar el viewlet</p>
</li>
</ul>
</div>
<div class="section" id="writing-the-viewlet-code">
<h2>Escribiendo el código fuente del Viewlet<a class="headerlink" href="#writing-the-viewlet-code" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Actualizar en la clase viewlet que contiene la lógica necesaria en el archivo <code class="file docutils literal"><span class="pre">browser/viewlets</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plone.app.layout.viewlets</span> <span class="kn">import</span> <span class="n">common</span> <span class="k">as</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">Products.CMFCore.permissions</span> <span class="kn">import</span> <span class="n">ViewManagementScreens</span>
<span class="kn">from</span> <span class="nn">Products.CMFCore.utils</span> <span class="kn">import</span> <span class="n">getToolByName</span>

<span class="kn">from</span> <span class="nn">starzel.votable_behavior.interfaces</span> <span class="kn">import</span> <span class="n">IVoting</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">ViewletBase</span><span class="p">):</span>

    <span class="n">vote</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">is_manager</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Vote</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vote</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vote</span> <span class="o">=</span> <span class="n">IVoting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_manager</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">membership_tool</span> <span class="o">=</span> <span class="n">getToolByName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;portal_membership&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_manager</span> <span class="o">=</span> <span class="n">membership_tool</span><span class="o">.</span><span class="n">checkPermission</span><span class="p">(</span>
                <span class="n">ViewManagementScreens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">voted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vote</span><span class="o">.</span><span class="n">already_voted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vote</span><span class="o">.</span><span class="n">average_vote</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vote</span><span class="o">.</span><span class="n">has_votes</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="the-template">
<h2>La plantilla<a class="headerlink" href="#the-template" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Y extiende la plantilla en el archivo <code class="file docutils literal"><span class="pre">browser/templates/voting_viewlet.pt</span></code></p>
<div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">tal:snippet</span> <span class="na">omit-tag</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;voting&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;current_rating&quot;</span> <span class="na">tal:condition</span><span class="o">=</span><span class="s">&quot;viewlet/has_votes&quot;</span><span class="p">&gt;</span>
      The average vote for this talk is <span class="p">&lt;</span><span class="nt">span</span> <span class="na">tal:content</span><span class="o">=</span><span class="s">&quot;viewlet/average&quot;</span><span class="p">&gt;</span>200<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;alreadyvoted&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;voting_option&quot;</span><span class="p">&gt;</span>
      You already voted this talk. Thank you!
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;notyetvoted&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;voting_option&quot;</span><span class="p">&gt;</span>
      What do you think of this talk?
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;votes&quot;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;voting_plus&quot;</span><span class="p">&gt;</span>+1<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;voting_neutral&quot;</span><span class="p">&gt;</span>0<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;voting_negative&quot;</span><span class="p">&gt;</span>-1<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;no_ratings&quot;</span> <span class="na">tal:condition</span><span class="o">=</span><span class="s">&quot;not: viewlet/has_votes&quot;</span><span class="p">&gt;</span>
      This talk has not been voted yet. Be the first!
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;delete_votings&quot;</span> <span class="na">tal:condition</span><span class="o">=</span><span class="s">&quot;viewlet/is_manager&quot;</span><span class="p">&gt;</span>
      Delete all votings
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;delete_votings2&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;areyousure warning&quot;</span>
         <span class="na">tal:condition</span><span class="o">=</span><span class="s">&quot;viewlet/is_manager&quot;</span>
         <span class="p">&gt;</span>
      Are you sure?
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;hiddenStructure&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;context_url&quot;</span>
       <span class="na">tal:attributes</span><span class="o">=</span><span class="s">&quot;href context/absolute_url&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;voted&quot;</span> <span class="na">tal:condition</span><span class="o">=</span><span class="s">&quot;viewlet/voted&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">starzel_votablebehavior</span><span class="p">.</span><span class="nx">init_voting_viewlet</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.voting&quot;</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tal:snippet</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Tenemos muchas piezas pequeñas, la mayoría de las cuales serán ocultadas por javascript a menos que sea necesario. Al proporcionar toda esta información de estado en HTML, podemos utilizar herramientas de traducción estándar para traducir. Traducir cadenas en javascript requiere trabajo adicional.</p>
<p>Nosotros necesitamos algunos css que almacenaremos en el archivo <code class="file docutils literal"><span class="pre">static/starzel_votablebehavior.css</span></code></p>
<div class="highlight-css"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nc">.voting</span> <span class="p">{</span>
    <span class="nb">float</span><span class="o">:</span> <span class="nb">right</span><span class="p">;</span>
    <span class="nb">border</span><span class="o">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#ddd</span><span class="p">;</span>
    <span class="nb">background-color</span><span class="o">:</span> <span class="m">#DDDDDD</span><span class="p">;</span>
    <span class="nb">padding</span><span class="o">:</span> <span class="m">0.5em</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nc">.voting_option</span> <span class="p">{</span>
    <span class="nb">display</span><span class="o">:</span> <span class="n">None</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.areyousure</span> <span class="p">{</span>
    <span class="nb">display</span><span class="o">:</span> <span class="n">None</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nt">div</span><span class="nc">.votes</span> <span class="nt">span</span> <span class="p">{</span>
    <span class="nb">border</span><span class="o">:</span> <span class="m">0</span> <span class="nb">solid</span> <span class="m">#DDDDDD</span><span class="p">;</span>
    <span class="nb">cursor</span><span class="o">:</span> <span class="nb">pointer</span><span class="p">;</span>
    <span class="nb">float</span><span class="o">:</span> <span class="nb">left</span><span class="p">;</span>
    <span class="nb">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">0.2em</span><span class="p">;</span>
    <span class="nb">padding</span><span class="o">:</span> <span class="m">0</span> <span class="m">0.5em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.votes</span> <span class="p">{</span>
    <span class="nb">display</span><span class="o">:</span> <span class="nb">inline</span><span class="p">;</span>
    <span class="nb">float</span><span class="o">:</span> <span class="nb">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nn">#voting_plus</span> <span class="p">{</span>
    <span class="nb">background-color</span><span class="o">:</span> <span class="n">LimeGreen</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nn">#voting_neutral</span> <span class="p">{</span>
    <span class="nb">background-color</span><span class="o">:</span> <span class="nb">yellow</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nn">#voting_negative</span> <span class="p">{</span>
    <span class="nb">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="the-javascript-code">
<h2>El código javascript<a class="headerlink" href="#the-javascript-code" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para que funcione en el navegador, algunos javascript en el archivo <code class="file docutils literal"><span class="pre">static/starzel_votablebehavior.js</span></code></p>
<div class="highlight-js"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*global location: false, window: false, jQuery: false */</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">starzel_votablebehavior</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="nx">starzel_votablebehavior</span><span class="p">.</span><span class="nx">init_voting_viewlet</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">notyetvoted</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#notyetvoted&quot;</span><span class="p">),</span>
            <span class="nx">alreadyvoted</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#alreadyvoted&quot;</span><span class="p">),</span>
            <span class="nx">delete_votings</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#delete_votings&quot;</span><span class="p">),</span>
            <span class="nx">delete_votings2</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#delete_votings2&quot;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voted&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alreadyvoted</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">notyetvoted</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">rating</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="nx">inner_vote</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#context_url&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/vote&#39;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">rating</span><span class="o">:</span> <span class="nx">rating</span>
                <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voting_plus&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">vote</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voting_neutral&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">vote</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voting_negative&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">vote</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

        <span class="nx">delete_votings</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">delete_votings2</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">delete_votings2</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#context_url&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/clearvotes&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">}(</span><span class="nx">jQuery</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">starzel_votablebehavior</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">starzel_votablebehavior</span> <span class="o">||</span> <span class="p">{}));</span>
</pre></div>
</td></tr></table></div>
<p>Este código js se adhiere a las reglas jshint de crockfort, por lo que todas las variables se declaran al principio del método. Mostramos y ocultamos bastantes pequeños elementos html aquí</p>
</div>
<div class="section" id="writing-2-simple-view-helpers">
<h2>Escribiendo 2 ejemplo de view helpers<a class="headerlink" href="#writing-2-simple-view-helpers" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Nuestro código javascript se comunica con nuestro sitio llamando a las vistas que aún no existen. Estas vistas no necesitan mostrar código html, pero deben devolver un estatus válido. Las excepciones establecen el estado correcto y no están siendo mostradas por javascript, por lo que nos conviene bien.</p>
<p>Como puede recordar, el método <code class="samp docutils literal"><span class="pre">vote</span></code> puede devolver una excepción, si alguien vota dos veces. No capturamos esta excepción. El usuario nunca verá esta excepción.</p>
<div class="admonition seealso">
<p class="first admonition-title">Ver también</p>
<p>La captura de excepciones contiene un comportamiento contra-intuitivo para los nuevos desarrolladores.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">something</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">fix_something</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Zope reclama algunas excepciones para sí mismos. Necesita que funcionen correctamente.</p>
<p>Por ejemplo, si dos solicitudes intentan modificar algo al mismo tiempo, una solicitud lanzará una excepción, a  <code class="samp docutils literal"><span class="pre">ConflictError</span></code>.</p>
<p class="last">Zope captura la excepción, espera una cantidad de tiempo aleatoria e intenta procesar la solicitud nuevamente, hasta tres veces. Si capturas esa excepción, estás en problemas, así que no lo hagas. Nunca.</p>
</div>
<p>Como tantas veces, debemos extender en el archivo <code class="file docutils literal"><span class="pre">browser/configure.zcml</span></code>:</p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span>...

<span class="nt">&lt;browser:page</span>
  <span class="na">name=</span><span class="s">&quot;vote&quot;</span>
  <span class="na">for=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVotable&quot;</span>
  <span class="na">layer=</span><span class="s">&quot;..interfaces.IVotableLayer&quot;</span>
  <span class="na">class=</span><span class="s">&quot;.vote.Vote&quot;</span>
  <span class="na">permission=</span><span class="s">&quot;zope2.View&quot;</span>
  <span class="nt">/&gt;</span>

<span class="nt">&lt;browser:page</span>
  <span class="na">name=</span><span class="s">&quot;clearvotes&quot;</span>
  <span class="na">for=</span><span class="s">&quot;starzel.votable_behavior.interfaces.IVotable&quot;</span>
  <span class="na">layer=</span><span class="s">&quot;..interfaces.IVotableLayer&quot;</span>
  <span class="na">class=</span><span class="s">&quot;.vote.ClearVotes&quot;</span>
  <span class="na">permission=</span><span class="s">&quot;zope2.ViewManagementScreens&quot;</span>
  <span class="nt">/&gt;</span>

...
</pre></div>
</td></tr></table></div>
<p>A continuación, agregamos nuestras vistas simples en el archivo <code class="file docutils literal"><span class="pre">browser/vote.py</span></code></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.publisher.browser</span> <span class="kn">import</span> <span class="n">BrowserPage</span>

<span class="kn">from</span> <span class="nn">starzel.votable_behavior.interfaces</span> <span class="kn">import</span> <span class="n">IVoting</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="n">BrowserPage</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rating</span><span class="p">):</span>
        <span class="n">voting</span> <span class="o">=</span> <span class="n">IVoting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">voting</span><span class="o">.</span><span class="n">vote</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;success&quot;</span>


<span class="k">class</span> <span class="nc">ClearVotes</span><span class="p">(</span><span class="n">BrowserPage</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">voting</span> <span class="o">=</span> <span class="n">IVoting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">voting</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;success&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Se han creado muchas partes móviles. Aquí hay un pequeño resumen:</p>
digraph composition {
rankdir=LR;
layout=fdp;
context[label=&quot;IVotable object&quot; shape=&quot;box&quot; pos=&quot;0,0!&quot;];
viewlet[label=&quot;Voting Viewlet&quot; pos=&quot;3,-1!&quot;];
helperview1[label=&quot;Helper View for Voting&quot; pos=&quot;3,0!&quot;];
helperview2[label=&quot;Helper View for deleting all votes&quot; pos=&quot;3,1!&quot;];
js[label=&quot;JS Code&quot; shape=&quot;box&quot; pos=&quot;6,0!&quot;];
viewlet -&gt; context [headlabel=&quot;reads&quot; labeldistance=&quot;3&quot;]
helperview1 -&gt; context [label=&quot;modifies&quot;]
helperview2 -&gt; context [label=&quot;modifies&quot;]
js -&gt; helperview1 [label=&quot;calls&quot;]
js -&gt; helperview2 [taillabel=&quot;calls&quot; labelangle=&quot;-10&quot; labeldistance=&quot;6&quot;]
viewlet -&gt; js [label=&quot;loads&quot;]
js -&gt; viewlet [headlabel=&quot;manipulates&quot; labeldistance=&quot;8&quot; labelangle=&quot;-10&quot;]
}
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reusable.html" class="btn btn-neutral float-right" title="33. Haciendo nuestro paquete reusable" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="behaviors2.html" class="btn btn-neutral" title="31. Más comportamientos complejos" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright El texto y las ilustraciones en este sitio Web esta licenciadas por la Plone Foundation bajo la licencia Creative Commons Attribution 4.0 International.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.2.5a',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .admonition-title").show();
        $(".toggle .admonition-title").click(function() {
            $(this).parent().children().not(".admonition-title").toggle(400);
            $(this).parent().children(".admonition-title").toggleClass("open");
        })
    });
</script>


</body>
</html>